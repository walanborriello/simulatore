{% extends 'base.html.twig' %}

{% block title %}Dettagli Studente - Simulatore CFU UniMarconi{% endblock %}

        {% block styles %}
        .student-details {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .student-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .student-info h1 {
            margin: 0;
            color: #E57552;
            font-size: 2em;
        }
        
        .student-email {
            color: #666;
            font-size: 1.1em;
            margin-top: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #379975;
            margin-bottom: 5px;
        }
        
        .detail-value {
            color: #444444;
        }
        
        .notes-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .btn-primary {
            background-color: #379975;
            color: white;
            padding: 12px 24px;
            font-size: 1.1em;
        }
        
        .btn-primary:hover {
            background-color: #2d7a5f;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 12px 24px;
            font-size: 1.1em;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 12px 24px;
            font-size: 1.1em;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .actions a {
            margin: 0 10px;
        }
        
        /* Simulazioni Table */
        .simulations-section {
            margin-top: 40px;
        }
        
        .simulations-title {
            color: #E57552;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .simulations-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .simulations-table th {
            background: #E57552;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .simulations-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .simulations-table tr:nth-child(even) td {
            background-color: #f8f9fa;
        }
        
        .simulations-pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .simulations-pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .simulations-pagination button:hover {
            background: #f8f9fa;
        }
        
        .simulations-pagination button.active {
            background: #379975;
            color: white;
            border-color: #379975;
        }
        
        .simulations-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Simulatore Styles (stesso stile di new.html.twig) */
        .simulator-container {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .simulator-title {
            color: #E57552;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .simulator-section {
            margin-bottom: 30px;
        }
        
        .discipline-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }
        
        .discipline-row .form-group {
            margin-bottom: 0;
        }
        
        .discipline-row .form-group:nth-child(1) { flex: 1; }
        .discipline-row .form-group:nth-child(2) { flex: 1; }
        .discipline-row .form-group:nth-child(3) { flex: 0.5; }
        .discipline-row .form-group:nth-child(4) { flex: 0.3; }
        
        .btn-add-discipline {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-add-discipline:hover {
            background: #218838;
        }
        
        .btn-remove-discipline {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-remove-discipline:hover {
            background: #c82333;
        }
        
        .btn-simulate {
            background: #E57552;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-simulate:hover {
            background: #d65a3f;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .field-error {
            border-color: #dc3545 !important;
        }
        
                .loading-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(255, 255, 255, 0.95);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                }
                
                .loading-content {
                    text-align: center;
                }
                
                .loading-spinner {
                    width: 60px;
                    height: 60px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #E57552;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                .loading-text {
                    color: #E57552;
                    font-size: 16px;
                    font-weight: 500;
                }
                
                /* Forza visibilit√† search box Select2 */
                .select2-search {
                    display: block !important;
                }
                
                .select2-search__field {
                    width: 100% !important;
                    padding: 8px !important;
                    border: 1px solid #ddd !important;
                    border-radius: 4px !important;
                }
                
                /* Stili Select2 per mantenere dimensioni corrette */
                .select2-container {
                    width: 100% !important;
                }
                
                .select2-container--default .select2-selection--single {
                    height: 40px !important;
                    border: 1px solid #ddd !important;
                    border-radius: 4px !important;
                    font-size: 14px !important;
                }
                
                .select2-container--default .select2-selection--single .select2-selection__rendered {
                    line-height: 38px !important;
                    padding-left: 12px !important;
                    color: #333 !important;
                }
                
                .select2-container--default .select2-selection--single .select2-selection__arrow {
                    height: 38px !important;
                    right: 8px !important;
                }
                
                .select2-dropdown {
                    border: 1px solid #ddd !important;
                    border-radius: 4px !important;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
                }
                
                .select2-results__option {
                    padding: 8px 12px !important;
                    font-size: 14px !important;
                }
                
                .select2-results__option--highlighted {
                    background-color: #E57552 !important;
                    color: white !important;
                }
        
        .results-container {
            margin-top: 30px;
            display: none;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .results-table th {
            background: #E57552;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .results-table tr:nth-child(even) td {
            background-color: #f8f9fa;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .pagination button:hover {
            background: #f8f9fa;
        }
        
        .pagination button.active {
            background: #379975;
            color: white;
            border-color: #379975;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444444;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #379975;
            box-shadow: 0 0 0 2px rgba(55, 153, 117, 0.2);
        }
        
        .required {
            color: #dc3545;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
{% endblock %}

{% block content %}
        <div class="student-details">
            <div class="student-header">
                <div class="student-info">
                    <h1>{{ student.fullName }}</h1>
                    <div class="student-email">{{ student.email }}</div>
                </div>
                <div class="header-actions">
                    <button type="button" class="btn btn-primary" id="toggle-simulator">üéì Simulatore</button>
                </div>
            </div>
            
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label">Codice Fiscale</div>
                    <div class="detail-value">{{ student.codiceFiscale }}</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Ateneo di Provenienza</div>
                    <div class="detail-value">{{ student.ateneoProvenienza }}</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Corso di Studio di Interesse</div>
                    <div class="detail-value">{{ student.corsoStudioInteresse }}</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Telefono</div>
                    <div class="detail-value">{{ student.phone }}</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Data Registrazione</div>
                    <div class="detail-value">{{ student.createdAt|date('d/m/Y H:i') }}</div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Ultimo Aggiornamento</div>
                    <div class="detail-value">{{ student.updatedAt|date('d/m/Y H:i') }}</div>
                </div>
            </div>
            
            {% if student.notes %}
            <div class="notes-section">
                <div class="detail-label">Note</div>
                <div class="detail-value">{{ student.notes }}</div>
            </div>
            {% endif %}
            
            <div class="actions">
                <a href="/student/{{ student.id }}/edit" class="btn btn-primary">Modifica</a>
                <a href="/student/{{ student.id }}/delete" class="btn btn-danger" onclick="return confirm('Sei sicuro di voler eliminare questo studente?')">Elimina</a>
                <a href="/" class="btn btn-secondary">Torna alla Lista</a>
            </div>
            
            <!-- Tabella Simulazioni -->
            <div class="simulations-section">
                <h2 class="simulations-title">üìä Simulazioni Effettuate</h2>
                <table class="simulations-table" id="simulations-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>CDL</th>
                            <th>CFU Riconosciuti</th>
                            <th>CFU Richiesti</th>
                            <th>CFU Integrativi</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for simulation in simulations %}
                        <tr>
                            <td>{{ simulation.createdAt|date('d/m/Y H:i') }}</td>
                            <td>{{ simulation.cdl }}</td>
                            <td>{{ simulation.totalCfuRecognized }}</td>
                            <td>{{ simulation.totalCfuRequired }}</td>
                            <td>{{ simulation.totalCfuIntegrative }}</td>
                            <td>
                                <button type="button" class="btn btn-secondary btn-small" onclick="viewSimulation({{ simulation.id }})">üëÅÔ∏è</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" style="text-align: center; color: #666;">
                                Nessuna simulazione effettuata per questo studente
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="simulations-pagination" id="simulations-pagination"></div>
            </div>
            
            <!-- Simulatore CFU -->
            <div class="simulator-container" id="simulator-container" style="display: none;">
                <h2 class="simulator-title">üéì Simulatore CFU</h2>
                
                <div class="simulator-section">
                    <div class="form-group">
                        <label for="simulator-cdl">Seleziona Corso di Laurea <span class="required">*</span></label>
                        <select id="simulator-cdl" name="simulator-cdl">
                            <option value="">Seleziona corso di laurea...</option>
                        </select>
                        <div class="error-message" id="cdl-error"></div>
                    </div>
                </div>
                
                <div class="simulator-section" id="discipline-section" style="display: none;">
                    <h3 style="color: #E57552; margin-bottom: 20px;">Discipline Esterne da Riconoscere</h3>
                    <div id="discipline-rows">
                        <!-- Le righe delle discipline verranno aggiunte dinamicamente -->
                    </div>
                    <button type="button" class="btn-add-discipline" id="add-discipline">+ Aggiungi Disciplina</button>
                    <button type="button" class="btn-simulate" id="simulate-btn">Calcola Simulazione</button>
                </div>
                
                <!-- Risultati -->
                <div class="results-container" id="results-container">
                    <h3 style="color: #E57552; margin-bottom: 20px;">Risultati Simulazione</h3>
                    
                    <!-- Tabella 1: Dettaglio -->
                    <div id="detail-table-container">
                        <h4>Dettaglio Riconoscimenti</h4>
                        <table class="results-table" id="detail-table">
                            <thead>
                                <tr>
                                    <th>Disciplina UniMarconi</th>
                                    <th>CFU Richiesti</th>
                                    <th>Disciplina Esterna</th>
                                    <th>CFU Assegnati</th>
                                    <th>Priorit√†</th>
                                    <th>Note</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="pagination" id="detail-pagination"></div>
                    </div>
                    
                    <!-- Tabella 2: Riepilogo -->
                    <div id="summary-table-container">
                        <h4>Riepilogo</h4>
                        <table class="results-table" id="summary-table">
                            <thead>
                                <tr>
                                    <th>Disciplina UniMarconi</th>
                                    <th>CFU Richiesti</th>
                                    <th>CFU Riconosciuti</th>
                                    <th>Integrativi Richiesti</th>
                                    <th>Stato</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="pagination" id="summary-pagination"></div>
                    </div>
                    
                    <!-- Tabella 3: Rimanenze -->
                    <div id="leftover-table-container">
                        <h4>Rimanenze</h4>
                        <table class="results-table" id="leftover-table">
                            <thead>
                                <tr>
                                    <th>Disciplina Esterna</th>
                                    <th>CFU Residui</th>
                                    <th>Motivazione</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="pagination" id="leftover-pagination"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">Caricamento in corso...</div>
            </div>
        </div>
        
        <script>
            // Variabili globali
            let disciplineCount = 0;
            let currentCdl = '';
            let ssdOptions = [];
            let currentResults = null;
            const studentId = {{ student.id }};
            
            // Inizializzazione
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üöÄ Inizializzazione simulatore...');
                console.log('jQuery disponibile:', typeof $ !== 'undefined');
                console.log('Select2 disponibile:', typeof $ !== 'undefined' && $.fn.select2);
                
                if (typeof $ !== 'undefined' && $.fn.select2) {
                    console.log('‚úÖ jQuery e Select2 disponibili, inizializzo...');
                    loadCdlOptions();
                } else {
                    console.log('‚ö†Ô∏è jQuery/Select2 non disponibili, uso fallback...');
                    loadCdlOptionsFallback();
                }
                
                addDisciplineRow(); // Riga 1
                addDisciplineRow(); // Riga 2
                addDisciplineRow(); // Riga 3 - Solo per grafica
                
                // Event listeners
                document.getElementById('toggle-simulator').addEventListener('click', toggleSimulator);
                
                const cdlSelect = document.getElementById('simulator-cdl');
                console.log('üîó Attaccando event listener a CDL select:', cdlSelect);
                
                // Usa l'evento Select2 se disponibile, altrimenti evento standard
                if (typeof $ !== 'undefined' && $.fn.select2) {
                    $(cdlSelect).on('change', handleCdlChange);
                    console.log('‚úÖ Event listener Select2 attaccato');
                } else {
                    cdlSelect.addEventListener('change', handleCdlChange);
                    console.log('‚úÖ Event listener standard attaccato');
                }
                
                document.getElementById('add-discipline').addEventListener('click', addDisciplineRow);
                document.getElementById('simulate-btn').addEventListener('click', simulate);
            });
            
            // Toggle simulatore
            function toggleSimulator() {
                const container = document.getElementById('simulator-container');
                const button = document.getElementById('toggle-simulator');
                
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    button.textContent = '‚ùå Chiudi Simulatore';
                    container.scrollIntoView({ behavior: 'smooth' });
                } else {
                    container.style.display = 'none';
                    button.textContent = 'üéì Simulatore';
                }
            }
            
            // Carica opzioni CDL (fallback senza Select2)
            async function loadCdlOptionsFallback() {
                try {
                    const response = await fetch('/api/cdl');
                    const cdlData = await response.json();
                    
                    const select = document.getElementById('simulator-cdl');
                    select.innerHTML = '<option value="">Seleziona corso di laurea...</option>';
                    
                    cdlData.forEach(cdl => {
                        const option = document.createElement('option');
                        option.value = cdl.id;
                        option.textContent = cdl.text;
                        select.appendChild(option);
                    });
                    
                    console.log('‚úÖ CDL caricati senza Select2');
                } catch (error) {
                    console.error('‚ùå Errore caricamento CDL:', error);
                }
            }
            
            // Carica opzioni CDL
            async function loadCdlOptions() {
                try {
                    const response = await fetch('/api/cdl');
                    const cdlData = await response.json();
                    
                    const select = document.getElementById('simulator-cdl');
                    cdlData.forEach(cdl => {
                        const option = document.createElement('option');
                        option.value = cdl.id;
                        option.textContent = cdl.text;
                        select.appendChild(option);
                    });
                    
                    // Distruggi Select2 esistente e ricostruisci
                    console.log('jQuery disponibile:', typeof $ !== 'undefined');
                    console.log('Select2 disponibile:', typeof $ !== 'undefined' && $.fn.select2);
                    
                    if (typeof $ !== 'undefined' && $.fn.select2) {
                        // Controlla se Select2 √® gi√† inizializzato
                        if ($('#simulator-cdl').hasClass('select2-hidden-accessible')) {
                            console.log('Select2 CDL gi√† inizializzato, distruggo e ricostruisco...');
                            $('#simulator-cdl').select2('destroy');
                        } else {
                            console.log('Select2 CDL non inizializzato, procedo con creazione...');
                        }
                        
                        // Inizializza Select2 con configurazione forzata
                        $('#simulator-cdl').select2({
                            placeholder: 'Seleziona corso di laurea...',
                            allowClear: true,
                            width: '100%',
                            minimumResultsForSearch: 1, // Mostra search box sempre
                            language: {
                                noResults: function() {
                                    return "Nessun risultato trovato";
                                },
                                searching: function() {
                                    return "Ricerca in corso...";
                                }
                            }
                        });
                        
                        // Forza la creazione della search box
                        setTimeout(function() {
                            const searchContainer = $('.select2-search');
                            if (searchContainer.length === 0) {
                                console.log('üîß Forzando creazione search box...');
                                $('.select2-dropdown').prepend('<div class="select2-search select2-search--dropdown"><input class="select2-search__field" type="search" tabindex="-1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="textbox" aria-autocomplete="list" placeholder="Cerca..."></div>');
                            }
                        }, 100);
                        
                        console.log('‚úÖ Select2 ricostruito per CDL con search box');
                    } else {
                        console.error('‚ùå jQuery o Select2 non caricati');
                        console.log('jQuery:', typeof $);
                        console.log('Select2:', typeof $ !== 'undefined' ? $.fn.select2 : 'jQuery non disponibile');
                    }
                    
                } catch (error) {
                    console.error('Errore nel caricamento CDL:', error);
                }
            }
            
            // Gestisce cambio CDL
            async function handleCdlChange() {
                console.log('üéØ handleCdlChange chiamata!');
                const cdlSelect = document.getElementById('simulator-cdl');
                const disciplineSection = document.getElementById('discipline-section');
                
                currentCdl = cdlSelect.value;
                console.log('üìã CDL selezionato:', currentCdl);
                
                if (currentCdl) {
                    disciplineSection.style.display = 'block';
                    showLoading();
                    
                    try {
                        await loadSsdOptions(currentCdl);
                        
                        if (ssdOptions.length === 0) {
                            showNoSsdMessage();
                        } else {
                            hideNoSsdMessage();
                            populateAllSsdSelects();
                        }
                        
                        // Scroll lento verso la sezione discipline
                        disciplineSection.scrollIntoView({ behavior: 'smooth' });
                    } finally {
                        hideLoading();
                    }
                } else {
                    disciplineSection.style.display = 'none';
                }
                
                clearError('cdl-error');
            }
            
            // Carica opzioni SSD per CDL
            async function loadSsdOptions(cdl) {
                try {
                    const response = await fetch(`/api/ssd/${cdl}`);
                    const ssdData = await response.json();
                    ssdOptions = ssdData || [];
                    console.log(`SSD caricati per ${cdl}:`, ssdOptions.length);
                } catch (error) {
                    console.error('Errore nel caricamento SSD:', error);
                    ssdOptions = [];
                }
            }
            
            // Popola tutte le select SSD
            function populateAllSsdSelects() {
                const ssdSelects = document.querySelectorAll('.ssd-select');
                ssdSelects.forEach(select => {
                    populateSsdSelect(select);
                });
            }
            
            // Popola una select SSD
            function populateSsdSelect(select) {
                select.innerHTML = '<option value="">Seleziona SSD...</option>';
                ssdOptions.forEach(ssd => {
                    const option = document.createElement('option');
                    option.value = ssd.id;
                    option.textContent = ssd.text;
                    select.appendChild(option);
                });
                
                // Distruggi Select2 esistente e ricostruisci
                console.log('Inizializzando Select2 per SSD...');
                console.log('jQuery disponibile per SSD:', typeof $ !== 'undefined');
                console.log('Select2 disponibile per SSD:', typeof $ !== 'undefined' && $.fn.select2);
                
                // Prova con Select2, fallback a select normale
                if (typeof $ !== 'undefined' && $.fn.select2) {
                    // Controlla se Select2 √® gi√† inizializzato
                    if ($(select).hasClass('select2-hidden-accessible')) {
                        console.log('Select2 SSD gi√† inizializzato, distruggo e ricostruisco...');
                        $(select).select2('destroy');
                    } else {
                        console.log('Select2 SSD non inizializzato, procedo con creazione...');
                    }
                    
                    $(select).select2({
                        placeholder: 'Seleziona SSD...',
                        allowClear: true,
                        width: '100%',
                        minimumResultsForSearch: 1, // Mostra search box sempre
                        language: {
                            noResults: function() {
                                return "Nessun risultato trovato";
                            },
                            searching: function() {
                                return "Ricerca in corso...";
                            }
                        }
                    });
                    
                    // Forza la creazione della search box per SSD
                    setTimeout(function() {
                        const searchContainer = $('.select2-search');
                        if (searchContainer.length === 0) {
                            console.log('üîß Forzando creazione search box per SSD...');
                            $('.select2-dropdown').prepend('<div class="select2-search select2-search--dropdown"><input class="select2-search__field" type="search" tabindex="-1" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="textbox" aria-autocomplete="list" placeholder="Cerca SSD..."></div>');
                        }
                    }, 100);
                    
                    console.log('‚úÖ Select2 ricostruito per SSD con search box');
                } else {
                    console.log('‚ö†Ô∏è Select2 non disponibile, uso select normale per SSD');
                    select.innerHTML = '<option value="">Seleziona SSD...</option>';
                    ssdOptions.forEach(ssd => {
                        const option = document.createElement('option');
                        option.value = ssd.id;
                        option.textContent = ssd.text;
                        select.appendChild(option);
                    });
                }
            }
            
            // Mostra messaggio nessun SSD disponibile
            function showNoSsdMessage() {
                let messageDiv = document.getElementById('no-ssd-message');
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'no-ssd-message';
                    messageDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center;';
                    messageDiv.innerHTML = '‚ö†Ô∏è Non ci sono discipline esterne disponibili per questo corso di laurea.';
                    
                    const disciplineRows = document.getElementById('discipline-rows');
                    disciplineRows.parentNode.insertBefore(messageDiv, disciplineRows);
                }
                messageDiv.style.display = 'block';
                
                // Nasconde le righe delle discipline e i pulsanti
                document.getElementById('discipline-rows').style.display = 'none';
                document.getElementById('add-discipline').style.display = 'none';
                document.getElementById('simulate-btn').style.display = 'none';
            }
            
            // Nasconde messaggio nessun SSD
            function hideNoSsdMessage() {
                const messageDiv = document.getElementById('no-ssd-message');
                if (messageDiv) {
                    messageDiv.style.display = 'none';
                }
                
                // Mostra le righe delle discipline e i pulsanti
                document.getElementById('discipline-rows').style.display = 'block';
                document.getElementById('add-discipline').style.display = 'block';
                document.getElementById('simulate-btn').style.display = 'block';
            }
            
            // Aggiunge riga disciplina
            function addDisciplineRow() {
                disciplineCount++;
                const container = document.getElementById('discipline-rows');
                
                const row = document.createElement('div');
                row.className = 'discipline-row';
                row.id = `discipline-row-${disciplineCount}`;
                
                row.innerHTML = `
                    <div class="form-group">
                        <label>SSD <span class="required">*</span></label>
                        <select class="ssd-select" name="ssd_${disciplineCount}">
                            <option value="">Seleziona SSD...</option>
                        </select>
                        <div class="error-message" id="ssd_${disciplineCount}_error"></div>
                    </div>
                    <div class="form-group">
                        <label>Nome Disciplina <span class="required">*</span></label>
                        <input type="text" name="nome_${disciplineCount}" placeholder="Nome disciplina...">
                        <div class="error-message" id="nome_${disciplineCount}_error"></div>
                    </div>
                    <div class="form-group">
                        <label>CFU <span class="required">*</span></label>
                        <input type="number" name="cfu_${disciplineCount}" min="1" max="30" placeholder="CFU">
                        <div class="error-message" id="cfu_${disciplineCount}_error"></div>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn-remove-discipline" onclick="removeDisciplineRow(${disciplineCount})">üóëÔ∏è</button>
                    </div>
                `;
                
                container.appendChild(row);
                
                        // Popola la select SSD se ci sono opzioni disponibili
                        if (ssdOptions.length > 0) {
                            const select = row.querySelector('.ssd-select');
                            populateSsdSelect(select);
                        }
                
                // Event listeners per validazione
                const inputs = row.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('focus', () => clearFieldError(input));
                    input.addEventListener('change', () => clearFieldError(input));
                });
                
                // Event listener per select SSD (usando Select2 se disponibile)
                const ssdSelect = row.querySelector('.ssd-select');
                if (ssdSelect) {
                    ssdSelect.addEventListener('focus', () => clearFieldError(ssdSelect));
                    // Usa Select2 change event se disponibile, altrimenti fallback su change standard
                    if (typeof $ !== 'undefined' && $.fn.select2) {
                        $(ssdSelect).on('change', () => clearFieldError(ssdSelect));
                    } else {
                        ssdSelect.addEventListener('change', () => clearFieldError(ssdSelect));
                    }
                }
            }
            
            // Rimuove riga disciplina
            window.removeDisciplineRow = function(id) {
                const row = document.getElementById(`discipline-row-${id}`);
                if (row && disciplineCount > 1) { // Posso eliminare se ce ne sono pi√π di 1
                    row.remove();
                    disciplineCount--; // Decrementa il contatore
                } else if (row && disciplineCount === 1) {
                    // Mostra errore se si prova a eliminare l'ultima riga
                    alert('‚ö†Ô∏è Deve essere presente almeno una disciplina per procedere con la simulazione.');
                }
            }
            
            // Simula
            async function simulate() {
                if (!validateForm()) {
                    return;
                }
                
                showLoading();
                
                try {
                    const data = {
                        cdl: currentCdl,
                        discipline: getDisciplineData(),
                        studentId: studentId
                    };
                    
                    const response = await fetch('/api/simulate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        currentResults = result.data;
                        displayResults(result.data);
                        
                        // Ricarica la pagina per aggiornare la tabella simulazioni
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        alert('Errore nella simulazione: ' + (result.error || 'Errore sconosciuto'));
                    }
                } catch (error) {
                    console.error('Errore:', error);
                    alert('Errore nella simulazione');
                } finally {
                    hideLoading();
                }
            }
            
            // Valida form
            function validateForm() {
                let isValid = true;
                
                // Valida CDL
                const cdlSelect = document.getElementById('simulator-cdl');
                if (!cdlSelect.value) {
                    showError('cdl-error', 'Seleziona un corso di laurea valido per procedere con la simulazione.');
                    isValid = false;
                }
                
                // Valida discipline
                const rows = document.querySelectorAll('.discipline-row');
                rows.forEach((row, index) => {
                    const ssdSelect = row.querySelector('.ssd-select');
                    const nomeInput = row.querySelector('input[name^="nome_"]');
                    const cfuInput = row.querySelector('input[name^="cfu_"]');
                    
                    if (!ssdSelect.value) {
                        showError(`ssd_${index + 1}_error`, 'Seleziona il settore scientifico disciplinare della materia che hai sostenuto.');
                        isValid = false;
                    }
                    
                    if (!nomeInput.value.trim()) {
                        showError(`nome_${index + 1}_error`, 'Inserisci il nome completo della disciplina che hai sostenuto.');
                        isValid = false;
                    }
                    
                    if (!cfuInput.value || cfuInput.value < 1 || cfuInput.value > 30) {
                        showError(`cfu_${index + 1}_error`, 'Inserisci il numero di crediti formativi universitari (CFU) della disciplina (1-30).');
                        isValid = false;
                    }
                });
                
                // Scroll al primo errore
                if (!isValid) {
                    const firstError = document.querySelector('.field-error, .error-message[style*="block"]');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth' });
                    }
                }
                
                return isValid;
            }
            
            // Ottiene dati discipline
            function getDisciplineData() {
                const data = [];
                const rows = document.querySelectorAll('.discipline-row');
                
                rows.forEach(row => {
                    const ssdSelect = row.querySelector('.ssd-select');
                    const nomeInput = row.querySelector('input[name^="nome_"]');
                    const cfuInput = row.querySelector('input[name^="cfu_"]');
                    
                    if (ssdSelect.value && nomeInput.value && cfuInput.value) {
                        data.push({
                            ssd: ssdSelect.value,
                            nome: nomeInput.value.trim(),
                            cfu: parseInt(cfuInput.value)
                        });
                    }
                });
                
                return data;
            }
            
            // Mostra risultati
            function displayResults(results) {
                const container = document.getElementById('results-container');
                container.style.display = 'block';
                
                displayTable('detail-table', results.detail, 'detail-pagination');
                displayTable('summary-table', results.summary, 'summary-pagination');
                displayTable('leftover-table', results.leftovers, 'leftover-pagination');
                
                container.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Mostra tabella con paginazione
            function displayTable(tableId, data, paginationId, itemsPerPage = 5) {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const pagination = document.getElementById(paginationId);
                
                tbody.innerHTML = '';
                pagination.innerHTML = '';
                
                if (data.length === 0) {
                    const row = tbody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = table.querySelectorAll('th').length;
                    cell.textContent = 'Nessun dato disponibile';
                    cell.style.textAlign = 'center';
                    return;
                }
                
                const totalPages = Math.ceil(data.length / itemsPerPage);
                let currentPage = 1;
                
                function showPage(page) {
                    tbody.innerHTML = '';
                    const start = (page - 1) * itemsPerPage;
                    const end = start + itemsPerPage;
                    const pageData = data.slice(start, end);
                    
                    pageData.forEach(item => {
                        const row = tbody.insertRow();
                        Object.values(item).forEach(value => {
                            const cell = row.insertCell();
                            cell.textContent = value || '';
                        });
                    });
                    
                    // Aggiorna paginazione
                    pagination.innerHTML = '';
                    for (let i = 1; i <= totalPages; i++) {
                        const button = document.createElement('button');
                        button.textContent = i;
                        button.className = i === page ? 'active' : '';
                        button.addEventListener('click', () => {
                            currentPage = i;
                            showPage(i);
                        });
                        pagination.appendChild(button);
                    }
                }
                
                showPage(1);
            }
            
            // Visualizza simulazione
            function viewSimulation(simulationId) {
                // Implementare visualizzazione dettagli simulazione
                alert('Visualizzazione simulazione ' + simulationId + ' - da implementare');
            }
            
            // Utility functions
            function showError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                    
                    // Aggiungi classe error al campo
                    const field = element.previousElementSibling;
                    if (field) {
                        field.classList.add('field-error');
                    }
                }
            }
            
            function clearError(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.style.display = 'none';
                    element.textContent = '';
                }
            }
            
            function clearFieldError(field) {
                const errorElement = field.parentNode.querySelector('.error-message');
                if (errorElement) {
                    clearError(errorElement.id);
                }
                field.classList.remove('field-error');
            }
            
            function showLoading() {
                document.getElementById('loading-overlay').style.display = 'flex';
            }
            
            function hideLoading() {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        </script>
{% endblock %}